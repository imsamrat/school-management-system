// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// User model for authentication (supports all roles)
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      Role     @default(STUDENT)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationship to role-specific profiles
  studentProfile StudentProfile?
  teacherProfile TeacherProfile?
  staffProfile   StaffProfile?

  // Relationships for activities
  sentMessages     Message[] @relation("MessageSender")
  receivedMessages Message[] @relation("MessageReceiver")
  announcements    Announcement[]

  @@map("users")
}

// Role enumeration
enum Role {
  ADMIN
  STAFF
  TEACHER
  STUDENT
}

// Student-specific profile
model StudentProfile {
  id       String @id @default(cuid())
  userId   String @unique
  rollNo   String @unique
  classId  String?
  section  String?
  parentName String?
  parentPhone String?
  address  String?
  dateOfBirth DateTime?
  admissionDate DateTime @default(now())
  profileImage String? // URL or path to profile image
  emergencyContact String? // Emergency contact information

  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  class    Class?  @relation(fields: [classId], references: [id])

  // Student activities
  attendances   Attendance[]
  grades        Grade[]
  assignments   AssignmentSubmission[]
  
  // Fee management
  studentFees   StudentFee[]
  payments      Payment[]
  monthlyDues   MonthlyDue[]

  @@map("student_profiles")
}

// Teacher-specific profile
model TeacherProfile {
  id           String @id @default(cuid())
  userId       String @unique
  employeeId   String @unique
  department   String?
  qualification String?
  experience   String?
  phone        String?
  address      String?
  joinDate     DateTime @default(now())
  profileImage String? // URL or path to profile image
  bio          String? // Teacher biography

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Teacher responsibilities
  classes      Class[]
  subjects     Subject[]
  attendances  Attendance[]
  assignments  Assignment[]
  grades       Grade[]

  @@map("teacher_profiles")
}

// Staff-specific profile
model StaffProfile {
  id         String @id @default(cuid())
  userId     String @unique
  employeeId String @unique
  department String?
  position   String?
  phone      String?
  address    String?
  joinDate   DateTime @default(now())

  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("staff_profiles")
}

// Class model
model Class {
  id          String @id @default(cuid())
  name        String // e.g., "10th Grade"
  section     String // e.g., "A", "B"
  teacherId   String?
  academicYear String
  capacity    Int?
  description String?
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())

  teacher     TeacherProfile? @relation(fields: [teacherId], references: [id])
  
  // Class relationships
  students      StudentProfile[]
  subjects      Subject[]
  attendances   Attendance[]
  assignments   Assignment[]
  timetables    Timetable[]
  feeStructures FeeStructure[]

  @@unique([name, section, academicYear])
  @@map("classes")
}

// Subject model
model Subject {
  id        String @id @default(cuid())
  name      String // e.g., "Mathematics", "Physics"
  code      String @unique // e.g., "MATH101"
  classId   String
  teacherId String?
  credits   Int    @default(1)
  isActive  Boolean @default(true)
  createdAt DateTime @default(now())

  class       Class            @relation(fields: [classId], references: [id])
  teacher     TeacherProfile?  @relation(fields: [teacherId], references: [id])
  
  // Subject activities
  attendances Attendance[]
  assignments Assignment[]
  grades      Grade[]
  timetables  Timetable[]

  @@map("subjects")
}

// Attendance model
model Attendance {
  id        String @id @default(cuid())
  studentId String
  classId   String
  subjectId String?
  teacherId String
  date      DateTime
  status    AttendanceStatus
  remarks   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student   StudentProfile @relation(fields: [studentId], references: [id])
  class     Class          @relation(fields: [classId], references: [id])
  subject   Subject?       @relation(fields: [subjectId], references: [id])
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id])

  @@unique([studentId, classId, subjectId, date])
  @@map("attendances")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

// Assignment model
model Assignment {
  id          String @id @default(cuid())
  title       String
  description String?
  classId     String
  subjectId   String
  teacherId   String
  dueDate     DateTime
  maxMarks    Int      @default(100)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  class       Class            @relation(fields: [classId], references: [id])
  subject     Subject          @relation(fields: [subjectId], references: [id])
  teacher     TeacherProfile   @relation(fields: [teacherId], references: [id])
  
  submissions AssignmentSubmission[]

  @@map("assignments")
}

// Assignment Submission model
model AssignmentSubmission {
  id           String @id @default(cuid())
  assignmentId String
  studentId    String
  content      String?
  filePath     String?
  marksObtained Int?
  feedback     String?
  submittedAt  DateTime @default(now())
  gradedAt     DateTime?

  assignment   Assignment     @relation(fields: [assignmentId], references: [id])
  student      StudentProfile @relation(fields: [studentId], references: [id])

  @@unique([assignmentId, studentId])
  @@map("assignment_submissions")
}

// Grade model
model Grade {
  id        String @id @default(cuid())
  studentId String
  subjectId String
  teacherId String
  examType  String // "Quiz", "Midterm", "Final", etc.
  maxMarks  Int
  obtainedMarks Int
  grade     String? // A, B, C, etc.
  remarks   String?
  examDate  DateTime
  published Boolean @default(false) // Whether grade is visible to students
  createdAt DateTime @default(now())

  student   StudentProfile @relation(fields: [studentId], references: [id])
  subject   Subject        @relation(fields: [subjectId], references: [id])
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id])

  @@map("grades")
}

// Fee Structure - Define fees for each class
model FeeStructure {
  id            String @id @default(cuid())
  classId       String
  feeTypeId     String
  amount        Decimal
  frequency     FeeFrequency // MONTHLY, QUARTERLY, YEARLY, ONE_TIME
  academicYear  String
  isActive      Boolean @default(true)
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  class         Class @relation(fields: [classId], references: [id])
  feeType       FeeType @relation(fields: [feeTypeId], references: [id])
  studentFees   StudentFee[]

  @@unique([classId, feeTypeId, academicYear])
  @@map("fee_structures")
}

// Fee Type - Types of fees (Tuition, Admission, Exam, etc.)
model FeeType {
  id            String @id @default(cuid())
  name          String @unique // "Tuition Fee", "Admission Fee", "Exam Fee"
  code          String @unique // "TUITION", "ADMISSION", "EXAM"
  category      FeeCategory
  isRecurring   Boolean @default(false) // For monthly/quarterly fees
  isActive      Boolean @default(true)
  description   String?
  createdAt     DateTime @default(now())

  feeStructures FeeStructure[]
  studentFees   StudentFee[]

  @@map("fee_types")
}

enum FeeCategory {
  ACADEMIC      // Tuition, Exam fees
  FACILITY      // Library, Lab, Sports
  TRANSPORT     // Bus fees
  HOSTEL        // Accommodation
  OTHER         // Miscellaneous
}

enum FeeFrequency {
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  YEARLY
  ONE_TIME
}

// Student Fee Assignment - Links students to their applicable fees
model StudentFee {
  id              String @id @default(cuid())
  studentId       String
  feeStructureId  String
  feeTypeId       String
  academicYear    String
  totalAmount     Decimal
  paidAmount      Decimal @default(0)
  discountAmount  Decimal @default(0)
  dueAmount       Decimal // Calculated: totalAmount - paidAmount - discountAmount
  status          FeeStatus @default(PENDING)
  dueDate         DateTime?
  lastPaymentDate DateTime?
  remarks         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  student         StudentProfile @relation(fields: [studentId], references: [id])
  feeStructure    FeeStructure @relation(fields: [feeStructureId], references: [id])
  feeType         FeeType @relation(fields: [feeTypeId], references: [id])
  
  payments        Payment[]
  monthlyDues     MonthlyDue[]

  @@map("student_fees")
}

// Payment Collection - Records each payment transaction
model Payment {
  id              String @id @default(cuid())
  studentFeeId    String
  studentId       String
  amount          Decimal
  discountAmount  Decimal @default(0)
  discountReason  String?
  paymentMethod   PaymentMethod
  paymentDate     DateTime @default(now())
  receiptNumber   String @unique
  transactionId   String?
  collectedBy     String // User ID of staff/admin who collected
  remarks         String?
  status          PaymentStatus @default(COMPLETED)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  studentFee      StudentFee @relation(fields: [studentFeeId], references: [id])
  student         StudentProfile @relation(fields: [studentId], references: [id])

  @@map("payments")
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  BANK_TRANSFER
  CHEQUE
  ONLINE
}

enum PaymentStatus {
  COMPLETED
  PENDING
  FAILED
  REFUNDED
}

enum FeeStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  WAIVED
}

// Monthly Due Tracking - For recurring fees like tuition (month-wise tracking)
model MonthlyDue {
  id            String @id @default(cuid())
  studentFeeId  String
  studentId     String
  month         Int // 1-12
  year          Int
  amount        Decimal
  paidAmount    Decimal @default(0)
  status        FeeStatus @default(PENDING)
  dueDate       DateTime
  paidDate      DateTime?
  remarks       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  studentFee    StudentFee @relation(fields: [studentFeeId], references: [id])
  student       StudentProfile @relation(fields: [studentId], references: [id])

  @@unique([studentFeeId, month, year])
  @@map("monthly_dues")
}

// Timetable model
model Timetable {
  id        String @id @default(cuid())
  classId   String
  subjectId String
  dayOfWeek Int // 1 = Monday, 7 = Sunday
  startTime String // "09:00"
  endTime   String // "10:00"
  room      String?
  isActive  Boolean @default(true)
  createdAt DateTime @default(now())

  class     Class   @relation(fields: [classId], references: [id])
  subject   Subject @relation(fields: [subjectId], references: [id])

  @@unique([classId, subjectId, dayOfWeek, startTime])
  @@map("timetables")
}

// Message model for communication
model Message {
  id         String @id @default(cuid())
  senderId   String
  receiverId String
  title      String
  content    String
  isRead     Boolean @default(false)
  createdAt  DateTime @default(now())

  sender     User @relation("MessageSender", fields: [senderId], references: [id])
  receiver   User @relation("MessageReceiver", fields: [receiverId], references: [id])

  @@map("messages")
}

// Announcement model
model Announcement {
  id        String @id @default(cuid())
  authorId  String
  title     String
  content   String
  targetRole Role? // If null, visible to all roles
  isActive  Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author    User @relation(fields: [authorId], references: [id])

  @@map("announcements")
}
